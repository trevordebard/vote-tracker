name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy target"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      ref:
        description: "Git ref to deploy (branch, tag, or SHA)"
        required: false
        default: "main"

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.event_name }}-${{ github.event.inputs.environment || 'dev' }}
      cancel-in-progress: false
    steps:
      - name: Resolve deploy target
        id: target
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=dev" >> "$GITHUB_OUTPUT"
            echo "ref=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
            echo "ref=${{ github.event.inputs.ref || 'main' }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.ref }}
          fetch-depth: 0

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: Add Dokku host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${DOKKU_HOST}" >> ~/.ssh/known_hosts
        env:
          DOKKU_HOST: 157.180.37.245

      - name: Set Dokku app
        id: app
        run: |
          if [ "${{ steps.target.outputs.environment }}" = "prod" ]; then
            echo "app=vote-tracker" >> "$GITHUB_OUTPUT"
          else
            echo "app=vote-tracker-dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy
        run: |
          git remote add dokku "dokku@${DOKKU_HOST}:${DOKKU_APP}"
          git push --force dokku HEAD:main
        env:
          DOKKU_HOST: 157.180.37.245
          DOKKU_APP: ${{ steps.app.outputs.app }}
